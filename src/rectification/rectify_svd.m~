function [JL, JR] = rectify_svd(IL, PL, IR, PR)
% source 'Tutorial on Rectification of St
% https://www.researchgate.net/publication/2841773_Tutorial_on_Rectification_of_Stereo_Images

% Note: ich weiß nicht, ob HL und HR falsch sind, oder ob imwarp etwas
% komisches macht, weil imwarp gibt immer nur 0 zurück
[HL, HR, ~, ~] = rectify_svd_algo(PL, PR);

tform = projective2d(HL);
[JL, ~] = imwarp(IL,tform);

tform = projective2d(HR);
[JR, ~] = imwarp(IR, tform);

end

function [HL, HR, Pn1, Pn2] = rectify_svd_algo(Po1, Po2)
%% focal length
au = norm(cross(Po1(1,1:3)', Po1(3,1:3)'));
av = norm(cross(Po1(2,1:3)', Po1(3,1:3)'));

%% potical centers
c1 = - inv(Po1(:, 1:3)) * Po1(:,4);
c2 = - inv(Po2(:, 1:3)) * Po2(:,4); 

%% retinal planes
fl = Po1(3, 1:3);
fr = Po2(3, 1:3);

nn = cross(fl, fr);

%% solve the four system
A = [[c1' 1]' [c2' 1]' [nn 0]' ]';
[U, S, V] = svd(A);
r = 1/(norm(V([1 2 3], 4)));
a3 = r * V(:, 4);

A = [[c1' 1]' [c2' 1]' [a3(1:3)' 0]' ]';
[U, S, V] = svd(A);
r = norm(av)/(norm(V([1 2 3], 4)));
a2 = r * V(:, 4);

A = [[c1' 1]' [a2(1:3)' 0]' [a3(1:3)' 0]' ]';
[U, S, V] = svd(A);
r = norm(au)/(norm(V([1 2 3], 4)));
a1 = r * V(:, 4);

A = [[c2' 1]' [a2(1:3)' 1]' [a3(1:3)' 0]' ]';
[U, S, V] = svd(A);
r = norm(au)/(norm(V([1 2 3], 4)));
b1 = r * V(:, 4);


%% rectifying projection matrices
H = eye(3,3);

Pn1 = H * [a1 a2 a3]';
Pn2 = H * [b1 a2 a3]';

%% rectifying image transformation
HL = Pn1(1:3, 1:3) / Po1(1:3, 1:3);
HR = Pn2(1:3, 1:3) / Po2(1:3, 1:3);

%% create homography matrix
[U, S, V] = svd(HL);
HL = U * (S / S(2,2)) * V;
[U, S, V] = svd(HR);
HR = U * (S / S(2,2)) * V;
end